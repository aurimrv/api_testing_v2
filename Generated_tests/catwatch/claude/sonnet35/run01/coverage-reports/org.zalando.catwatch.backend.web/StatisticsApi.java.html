<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StatisticsApi.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">catwatch-backend</a> &gt; <a href="index.source.html" class="el_package">org.zalando.catwatch.backend.web</a> &gt; <span class="el_source">StatisticsApi.java</span></div><h1>StatisticsApi.java</h1><pre class="source lang-java linenums">package org.zalando.catwatch.backend.web;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import io.swagger.annotations.ApiResponse;
import io.swagger.annotations.ApiResponses;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.env.Environment;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.zalando.catwatch.backend.model.Contributor;
import org.zalando.catwatch.backend.model.Project;
import org.zalando.catwatch.backend.model.Statistics;
import org.zalando.catwatch.backend.repo.ContributorRepository;
import org.zalando.catwatch.backend.repo.ProjectRepository;
import org.zalando.catwatch.backend.repo.StatisticsRepository;
import org.zalando.catwatch.backend.service.StatisticsService;
import org.zalando.catwatch.backend.util.Constants;
import org.zalando.catwatch.backend.util.ContributorStats;
import org.zalando.catwatch.backend.util.LanguageStats;
import org.zalando.catwatch.backend.util.ProjectStats;
import org.zalando.catwatch.backend.util.StringParser;

import java.time.temporal.ChronoUnit;
import java.util.Collection;
import java.util.Date;
import java.util.List;

import static org.springframework.http.MediaType.APPLICATION_JSON_VALUE;

<span class="pc bpc" id="L39" title="1 of 2 branches missed.">@Controller</span>
@RequestMapping(value = Constants.API_RESOURCE_STATISTICS, produces = { APPLICATION_JSON_VALUE })
@Api(value = Constants.API_RESOURCE_STATISTICS, description = &quot;the statistics API&quot;)
public class StatisticsApi {

	private final StatisticsRepository repository;
	private final ProjectRepository projectRepository;
	private final ContributorRepository contributorRepository;
	private final Environment env;

	@Autowired
	public StatisticsApi(StatisticsRepository repository,
						 ProjectRepository projectRepository,
						 ContributorRepository contributorRepository,
<span class="fc" id="L53">						 Environment env) {</span>
<span class="fc" id="L54">		this.repository = repository;</span>
<span class="fc" id="L55">		this.projectRepository = projectRepository;</span>
<span class="fc" id="L56">		this.contributorRepository = contributorRepository;</span>
<span class="fc" id="L57">		this.env = env;</span>
<span class="fc" id="L58">	}</span>

	@ApiOperation(value = &quot;General Statistics of list of Github.com Organizations&quot;, notes = &quot;The Statistics endpoint returns snapshot of statistics over a given period of time of the organization \nGithub account. Statistics contains information of the count of all private projects,  public projects,              members, teams, contributors, stars, forks, size, programming languages, tags of the list of Github.com              Organizations.\n&quot;, response = Statistics.class, responseContainer = &quot;List&quot;)
	@ApiResponses(value = { @ApiResponse(code = 200, message = &quot;An array of Statistics over selected period of time.&quot;),
			@ApiResponse(code = 0, message = &quot;Unexpected error&quot;) })
	@RequestMapping(value = &quot;&quot;, method = RequestMethod.GET)
	public ResponseEntity&lt;Collection&lt;Statistics&gt;&gt; statisticsGet(
			@ApiParam(value = &quot;List of github.com organizations to scan(comma seperated)&quot;, required = false) @RequestParam(value = Constants.API_REQUEST_PARAM_ORGANIZATIONS, required = false) String organizations,

	@ApiParam(value = &quot;Date from which to start fetching statistics records from database(default = current date)&quot;) @RequestParam(value = Constants.API_REQUEST_PARAM_STARTDATE, required = false) String startDate,

	@ApiParam(value = &quot;Date till which statistics records will be fetched from database(default = current date)&quot;) @RequestParam(value = Constants.API_REQUEST_PARAM_ENDDATE, required = false) String endDate

	) {

<span class="fc" id="L73">		String organisationList = organizations;</span>

<span class="fc bfc" id="L75" title="All 2 branches covered.">		if (organisationList == null) {</span>
<span class="fc" id="L76">			organisationList = getOrganizationConfig();</span>
		}

<span class="fc" id="L79">		Collection&lt;String&gt; orgs = StringParser.parseStringList(organisationList, &quot;,&quot;);</span>

<span class="fc" id="L81">		Collection&lt;Statistics&gt; statistics = StatisticsService.getStatistics(repository, orgs, startDate, endDate);</span>

<span class="fc" id="L83">		return new ResponseEntity&lt;&gt;(statistics, HttpStatus.OK);</span>
	}

	private Date parseDate(String dateString, Date defaultValue) {
<span class="fc bfc" id="L87" title="All 2 branches covered.">		if (dateString == null)</span>
<span class="fc" id="L88">			return defaultValue;</span>
		else {
			try {
<span class="fc" id="L91">				return StringParser.parseIso8601Date(dateString);</span>
<span class="fc" id="L92">			} catch(java.text.ParseException e) {</span>
<span class="fc" id="L93">				throw new IllegalArgumentException(&quot;Couldn't parse date string &quot; + dateString + &quot;.&quot;);</span>
			}
		}
	}

	@RequestMapping(value = &quot;/projects&quot;, method = RequestMethod.GET)
	public ResponseEntity&lt;Collection&lt;ProjectStats&gt;&gt; statisticsProjectGet(
			@ApiParam(value = &quot;List of github.com organizations to scan(comma seperated)&quot;, required = false)
			@RequestParam(value = Constants.API_REQUEST_PARAM_ORGANIZATIONS, required = false)
			String organizations,
			@ApiParam(value = &quot;Date from which to start fetching statistics records from database(default = current date)&quot;)
			@RequestParam(value = Constants.API_REQUEST_PARAM_STARTDATE, required = false)
			String startDateString,
			@ApiParam(value = &quot;Date till which statistics records will be fetched from database(default = current date)&quot;)
			@RequestParam(value = Constants.API_REQUEST_PARAM_ENDDATE, required = false)
			String endDateString
	) throws java.text.ParseException {

<span class="fc" id="L111">		Date now = new Date();</span>

<span class="fc" id="L113">		Date startDate = parseDate(startDateString, Date.from(now.toInstant().minus(30, ChronoUnit.DAYS)));</span>
<span class="fc" id="L114">		Date endDate = parseDate(endDateString, now);</span>

<span class="fc" id="L116">		List&lt;Project&gt; projects = null;</span>

<span class="fc bfc" id="L118" title="All 2 branches covered.">		if (organizations == null) {</span>
<span class="fc" id="L119">			projects = projectRepository.findProjectsByDateRange(startDate, endDate);</span>
		} else {
<span class="fc" id="L121">			Collection&lt;String&gt; orgs = StringParser.parseStringList(organizations, &quot;,&quot;);</span>
<span class="fc" id="L122">			projects = projectRepository.findProjectsByOrganizationNameAndDateRange(orgs, startDate, endDate);</span>
		}
<span class="pc bpc" id="L124" title="2 of 4 branches missed.">		assert (projects != null);</span>

<span class="fc" id="L126">		List&lt;ProjectStats&gt; result = ProjectStats.buildStats(projects);</span>

		// only top 10 by last score
<span class="pc" id="L129">		result.sort((ps1, ps2) -&gt; -ps1.getScores().get(ps1.getScores().size() - 1)</span>
<span class="nc" id="L130">			.compareTo(ps2.getScores().get(ps2.getScores().size() - 1)));</span>

<span class="nc" id="L132">		ResponseEntity&lt;Collection&lt;ProjectStats&gt;&gt; res = new ResponseEntity&lt;&gt;(result.subList(0, 10), HttpStatus.OK);</span>

<span class="nc" id="L134">		return res;</span>
	}

    @RequestMapping(value = &quot;/contributors&quot;, method = RequestMethod.GET)
	public ResponseEntity&lt;Collection&lt;ContributorStats&gt;&gt; statisticsContributorGet(
            @ApiParam(value = &quot;List of github.com organizations to scan(comma seperated)&quot;, required = false)
            @RequestParam(value = Constants.API_REQUEST_PARAM_ORGANIZATIONS, required = false)
			String organizations,
            @ApiParam(value = &quot;Date from which to start fetching statistics records from database(default = current date)&quot;)
            @RequestParam(value = Constants.API_REQUEST_PARAM_STARTDATE, required = false)
			String startDateString,
            @ApiParam(value = &quot;Date till which statistics records will be fetched from database(default = current date)&quot;)
            @RequestParam(value = Constants.API_REQUEST_PARAM_ENDDATE, required = false)
			String endDateString
	) throws java.text.ParseException {
<span class="fc" id="L149">		Date now = new Date();</span>
<span class="fc" id="L150">        Date startDate = parseDate(startDateString, Date.from(now.toInstant().minus(30, ChronoUnit.DAYS)));</span>
<span class="fc" id="L151">        Date endDate = parseDate(endDateString, now);</span>
<span class="fc" id="L152">        List&lt;Contributor&gt; contributors = null;</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">        if (organizations == null) {</span>
<span class="fc" id="L154">            contributors = contributorRepository.findContributorsTimeSeries(null, startDate, endDate, null);</span>
        } else {
<span class="fc" id="L156">			Collection&lt;String&gt; orgs = StringParser.parseStringList(organizations, &quot;,&quot;);</span>
<span class="fc" id="L157">			contributors = contributorRepository.findContributorsByOrganizationAndDate(orgs, startDate, endDate);</span>
        }
<span class="pc bpc" id="L159" title="2 of 4 branches missed.">        assert (contributors != null);</span>
<span class="fc" id="L160">        List&lt;ContributorStats&gt; result = ContributorStats.buildStats(contributors);</span>

<span class="pc" id="L162">        result.sort((cs1, cs2) -&gt; -cs1.getOrganizationalCommitsCounts().get(cs1.getOrganizationalCommitsCounts().size()-1)</span>
<span class="nc" id="L163">                .compareTo(cs2.getOrganizationalCommitsCounts().get(cs2.getOrganizationalCommitsCounts().size()-1)));</span>

<span class="nc" id="L165">        return new ResponseEntity&lt;&gt;(result.subList(0, 10), HttpStatus.OK);</span>
	}

	@ExceptionHandler(IllegalArgumentException.class)
	@ResponseBody
	@ResponseStatus(value = HttpStatus.BAD_REQUEST)
	public String handleException(Exception e) {
<span class="fc" id="L172">		return e.getMessage();</span>
	}

	
	private String getOrganizationConfig() {

<span class="pc bpc" id="L178" title="1 of 2 branches missed.">		if (!env.containsProperty(Constants.CONFIG_ORGANIZATION_LIST)) {</span>
			// TODO throw new exception
<span class="nc" id="L180">			return &quot;&quot;;</span>
		}

<span class="fc" id="L183">		return env.getProperty(Constants.CONFIG_ORGANIZATION_LIST);</span>
	}

    @RequestMapping(value = &quot;/languages&quot;, method = RequestMethod.GET)
    public ResponseEntity&lt;Collection&lt;LanguageStats&gt;&gt; statisticsLanguagesGet(
            @ApiParam(value = &quot;List of github.com organizations to scan(comma seperated)&quot;, required = false)
            @RequestParam(value = Constants.API_REQUEST_PARAM_ORGANIZATIONS, required = false)
            String organizations,
            @ApiParam(value = &quot;Date from which to start fetching statistics records from database(default = current date)&quot;)
            @RequestParam(value = Constants.API_REQUEST_PARAM_STARTDATE, required = false)
            String startDateString,
            @ApiParam(value = &quot;Date till which statistics records will be fetched from database(default = current date)&quot;)
            @RequestParam(value = Constants.API_REQUEST_PARAM_ENDDATE, required = false)
            String endDateString
    ) {
<span class="fc" id="L198">        Date now = new Date();</span>

<span class="fc" id="L200">        Date startDate = parseDate(startDateString, Date.from(now.toInstant().minus(30, ChronoUnit.DAYS)));</span>
<span class="fc" id="L201">        Date endDate = parseDate(endDateString, now);</span>

<span class="fc bfc" id="L203" title="All 2 branches covered.">        if (organizations == null) {</span>
<span class="fc" id="L204">            organizations = getOrganizationConfig();</span>
        }

<span class="fc" id="L207">        Collection&lt;String&gt; orgs = StringParser.parseStringList(organizations, &quot;,&quot;);</span>
<span class="fc" id="L208">        List&lt;Project&gt; projects = projectRepository.findProjectsByOrganizationNameAndDateRange(orgs, startDate, endDate);</span>
<span class="pc bpc" id="L209" title="2 of 4 branches missed.">        assert (projects != null);</span>

<span class="fc" id="L211">        List&lt;LanguageStats&gt; languageStats = LanguageStats.buildStats(projects);</span>

<span class="fc" id="L213">        return new ResponseEntity&lt;&gt;(languageStats, HttpStatus.OK);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>